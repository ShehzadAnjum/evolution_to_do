name: CD - Deploy to AKS

on:
  workflow_run:
    workflows: ["CI - Build and Push Docker Images"]
    types:
      - completed
    branches: [main]

env:
  AZURE_RESOURCE_GROUP: evo-todo-rg
  AKS_CLUSTER_NAME: evo-todo-aks
  HELM_RELEASE_NAME: evolution-todo

jobs:
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} \
            ./infra/helm/evolution-todo \
            --set backend.image.tag=${{ github.sha }} \
            --set frontend.image.tag=${{ github.sha }} \
            --set backend.env.DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            --set backend.env.BETTER_AUTH_SECRET="${{ secrets.BETTER_AUTH_SECRET }}" \
            --set backend.env.OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            --set ingress.enabled=false \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/backend --timeout=120s
          kubectl rollout status deployment/frontend --timeout=120s
          echo "Deployment successful!"
          echo ""
          echo "## Deployed Services" >> $GITHUB_STEP_SUMMARY
          kubectl get services -o wide >> $GITHUB_STEP_SUMMARY
