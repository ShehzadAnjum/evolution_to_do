name: CD - Deploy to AKS

on:
  workflow_run:
    workflows: ["CI - Build and Push Docker Images"]
    types:
      - completed
    branches: [main]

env:
  AZURE_RESOURCE_GROUP: evo-todo-rg
  AKS_CLUSTER_NAME: evo-todo-aks
  HELM_RELEASE_NAME: evolution-todo

jobs:
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Deploy with Helm
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          # Use short SHA (7 chars) to match CI image tags, or 'latest'
          IMAGE_TAG: latest
        run: |
          # Create values file with secrets (use env vars to avoid shell escaping issues)
          cat > /tmp/secrets-values.yaml << EOF
          backend:
            image:
              tag: "${IMAGE_TAG}"
            env:
              DATABASE_URL: "${DATABASE_URL}"
              BETTER_AUTH_SECRET: "${BETTER_AUTH_SECRET}"
              OPENAI_API_KEY: "${OPENAI_API_KEY}"
          frontend:
            image:
              tag: "${IMAGE_TAG}"
            env:
              DATABASE_URL: "${DATABASE_URL}"
              BETTER_AUTH_SECRET: "${BETTER_AUTH_SECRET}"
              BETTER_AUTH_URL: "http://172.171.119.133.nip.io:3000"
              GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID}"
              GOOGLE_CLIENT_SECRET: "${GOOGLE_CLIENT_SECRET}"
          ingress:
            enabled: false
          EOF

          # Deploy
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} \
            ./infra/helm/evolution-todo \
            -f /tmp/secrets-values.yaml \
            --wait \
            --timeout 5m

          # Cleanup
          rm -f /tmp/secrets-values.yaml

      - name: Force pod restart to pull latest images
        run: |
          # Force restart to ensure pods pull the latest images
          # Required because 'latest' tag + unchanged spec = no restart
          kubectl rollout restart deployment/frontend
          kubectl rollout restart deployment/backend

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/backend --timeout=120s
          kubectl rollout status deployment/frontend --timeout=120s
          echo "Deployment successful!"
          echo ""
          echo "## Deployed Services" >> $GITHUB_STEP_SUMMARY
          kubectl get services -o wide >> $GITHUB_STEP_SUMMARY
