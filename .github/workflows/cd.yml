name: CD - Deploy to AKS

on:
  workflow_run:
    workflows: ["CI - Build and Push Docker Images"]
    types:
      - completed
    branches: [main]

env:
  AZURE_RESOURCE_GROUP: evo-todo-rg
  AKS_CLUSTER_NAME: evo-todo-aks
  HELM_RELEASE_NAME: evolution-todo

jobs:
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install Dapr on AKS
        run: |
          # Check if Dapr is already installed
          if ! kubectl get namespace dapr-system > /dev/null 2>&1; then
            echo "Installing Dapr on AKS..."
            # Add Dapr Helm repo
            helm repo add dapr https://dapr.github.io/helm-charts/
            helm repo update
            # Install Dapr
            helm upgrade --install dapr dapr/dapr \
              --namespace dapr-system \
              --create-namespace \
              --wait \
              --timeout 5m
            echo "Dapr installed successfully"
          else
            echo "Dapr already installed, upgrading..."
            helm repo add dapr https://dapr.github.io/helm-charts/
            helm repo update
            helm upgrade dapr dapr/dapr \
              --namespace dapr-system \
              --wait \
              --timeout 5m
          fi

          # Verify Dapr installation
          kubectl get pods -n dapr-system

      - name: Deploy Dapr Components
        env:
          REDPANDA_BROKERS: ${{ secrets.REDPANDA_BROKERS }}
          REDPANDA_USERNAME: ${{ secrets.REDPANDA_USERNAME }}
          REDPANDA_PASSWORD: ${{ secrets.REDPANDA_PASSWORD }}
        run: |
          # Create namespace if not exists
          kubectl create namespace evolution-todo --dry-run=client -o yaml | kubectl apply -f -

          # Apply Dapr components
          if [ -n "$REDPANDA_BROKERS" ]; then
            echo "Configuring Dapr with Redpanda Cloud..."
            # Create secret for Redpanda credentials
            kubectl create secret generic redpanda-credentials \
              --namespace evolution-todo \
              --from-literal=username="${REDPANDA_USERNAME}" \
              --from-literal=password="${REDPANDA_PASSWORD}" \
              --dry-run=client -o yaml | kubectl apply -f -

            # Apply Redpanda pubsub component
            kubectl apply -f infra/dapr/cloud/pubsub-redpanda.yaml
          else
            echo "Redpanda not configured, using in-memory pub/sub for demo..."
            kubectl apply -f infra/dapr/cloud/pubsub-memory.yaml
          fi

          # Apply state store (PostgreSQL via Neon)
          kubectl apply -f infra/dapr/cloud/statestore.yaml

      - name: Deploy with Helm
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          # MQTT Configuration for IoT Device Control
          MQTT_BROKER: ${{ secrets.MQTT_BROKER }}
          MQTT_PORT: ${{ secrets.MQTT_PORT }}
          MQTT_USERNAME: ${{ secrets.MQTT_USERNAME }}
          MQTT_PASSWORD: ${{ secrets.MQTT_PASSWORD }}
          # Use short SHA (7 chars) to match CI image tags, or 'latest'
          IMAGE_TAG: latest
        run: |
          # Create values file with secrets (use env vars to avoid shell escaping issues)
          cat > /tmp/secrets-values.yaml << EOF
          backend:
            image:
              tag: "${IMAGE_TAG}"
            env:
              DATABASE_URL: "${DATABASE_URL}"
              BETTER_AUTH_SECRET: "${BETTER_AUTH_SECRET}"
              OPENAI_API_KEY: "${OPENAI_API_KEY}"
              MQTT_BROKER: "${MQTT_BROKER}"
              MQTT_PORT: "${MQTT_PORT}"
              MQTT_USERNAME: "${MQTT_USERNAME}"
              MQTT_PASSWORD: "${MQTT_PASSWORD}"
              MQTT_ENABLED: "true"
          frontend:
            image:
              tag: "${IMAGE_TAG}"
            env:
              DATABASE_URL: "${DATABASE_URL}"
              BETTER_AUTH_SECRET: "${BETTER_AUTH_SECRET}"
              BETTER_AUTH_URL: "http://172.171.119.133.nip.io:3000"
              GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID}"
              GOOGLE_CLIENT_SECRET: "${GOOGLE_CLIENT_SECRET}"
          ingress:
            enabled: false
          EOF

          # Deploy
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} \
            ./infra/helm/evolution-todo \
            -f /tmp/secrets-values.yaml \
            --wait \
            --timeout 5m

          # Cleanup
          rm -f /tmp/secrets-values.yaml

      - name: Force pod restart to pull latest images
        run: |
          # Force restart to ensure pods pull the latest images
          # Required because 'latest' tag + unchanged spec = no restart
          kubectl rollout restart deployment/frontend
          kubectl rollout restart deployment/backend

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/backend --timeout=120s
          kubectl rollout status deployment/frontend --timeout=120s
          echo "Deployment successful!"
          echo ""
          echo "## Deployed Services" >> $GITHUB_STEP_SUMMARY
          kubectl get services -o wide >> $GITHUB_STEP_SUMMARY
